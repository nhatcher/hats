<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hats and SAT Solvers</title>
    <link href="style.css" rel="stylesheet" />
    <link rel="stylesheet" href="vendor/coloris.min.css"/>
    <script src="vendor/coloris.min.js"></script>
    <script type="module">
        import __wbg_init, {solveSat} from './pkg/splr_wasm.js';
        import createClauses, {fromIndexToTile, addHatsToClauses} from './clauses.js';
        import Grid from './grid.js';

        const grid = new Grid(800, 400, 15, 13);
        const canvas = document.getElementById('canvas');
        const infoBar = document.getElementById('info');
        infoBar.style.width = "800px";

        canvas.addEventListener('keydown', (event) => {
            if (event.code === 'Escape' && document.getElementById('full-screen').checked) {
                // Exit full screen
                document.getElementById('full-screen').checked = false;
                grid.setDimensions(800, 400);
                document.querySelectorAll('.extras').forEach(el => el.style.display = "block");
                infoBar.style.width = "800px";
            }
            grid.onKeydown(event);
        });

        canvas.addEventListener('mouseup', grid.redraw);
        canvas.focus();

        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            try { 
                const data = JSON.parse(urlParams.get('data'));
                const hats = data.hats.map(h=> {
                    return {
                        x: h[0],
                        y: h[1],
                        beta: h[2],
                        sign: h[3],
                    }
                });
                grid.setTiles(hats);
                document.querySelectorAll('.color.hat').forEach( (s, i) => {
                    s.value = data.hatColors[i];
                    s.dispatchEvent(new Event('input', { bubbles: true }));
                });
                document.querySelectorAll('.color.cher').forEach( (s, i) => {
                    s.value = data.antiHatColors[i];
                    s.dispatchEvent(new Event('input', { bubbles: true }));
                });
            } catch(e) {
                // console.log(e);
            }

            grid.redraw();
        });

        document.addEventListener('change', (event) => {
            grid.redraw();
        })

        document.getElementById("column-count").addEventListener("change", () => {
            const columnCount = document.getElementById("column-count").valueAsNumber;
            grid.setColumnCount(columnCount);
            grid.redraw();
        });


        async function solve() {
            await __wbg_init();
            const {columnCount, rowCount} = grid.getDimensions();
            const tileKinds = [];
            if (document.getElementById("tiles-hat").checked) {
                tileKinds.push(1);
            }
            if (document.getElementById("tiles-anti-hat").checked) {
                tileKinds.push(2);
            }
            if (document.getElementById("tiles-turtle").checked) {
                tileKinds.push(3);
            }
            if (document.getElementById("tiles-anti-turtle").checked) {
                tileKinds.push(4);
            }
            const {data, clausesCount} = createClauses(columnCount , rowCount, tileKinds);
            addHatsToClauses(grid.tiles.map((h) => {
                return {
                    m: h.x+2,
                    n: h.y+2,
                    kind: h.kind,
                    i: h.beta,
                }
            }), data);
            const t0 = performance.now();
            const x = solveSat(data);
            const t1 = performance.now();
            const ret = JSON.parse(x);
            if (ret.success) {
                const r = ret.result.filter(i => i > 0);
                const tiles = r.map(h => fromIndexToTile(h)).map( (h) => { return {
                    x:h.m - 2,
                    y:h.n - 2,
                    beta: h.i,
                    kind: h.kind,
                    isDragging: false,
                    isSelected: false,
                };});
                grid.setTiles(tiles);
                grid.redraw();
                infoBar.innerText = `Success! Solved in ${(t1-t0).toFixed(2)} milliseconds. ${tiles.length} tiles and ${clausesCount} clauses`;
            } else {
                infoBar.innerText = `Failed: ${ret.details}`;
            }
        }
        document.getElementById('solve-button').addEventListener('click', solve);
        document.getElementById('full-screen').addEventListener('change', (event) => {
            if (event.target.checked) {
                grid.setDimensions(window.innerWidth, window.innerHeight - 35);
                document.querySelectorAll('.extras').forEach(el => el.style.display = "none");
            }
            canvas.focus();
        });
        window.addEventListener('resize', (event) => {
            if (document.getElementById('full-screen').checked) {
                grid.setDimensions(window.innerWidth, window.innerHeight - 35);
                document.querySelectorAll('.extras').forEach(el => el.style.display = "none");
                infoBar.style.top = `${window.innerHeight-35}px`;
                infoBar.style.width = `${window.innerWidth}px`;
            }
        });

        const share_button = document.getElementById('share-button');
        share_button.addEventListener("click", function () {
            const href = window.location.href;
            const url = href.slice(0, href.lastIndexOf('/'));
            const state = {
                hatColors: grid.hatColors,
                antiHatColors: grid.antiHatColors,
                hats: grid.tiles.map((h)=>[h.x,h.y,h.beta,h.kind]),
            }
            const copyText = document.getElementById('hidden-input');
            const share = `${url}/?data=${encodeURIComponent(JSON.stringify(state))}`;
            copyText.value = share;
            copyText.select();
            document.execCommand('copy');
            alert('URL copied to your clipboard');
        });
    </script>
</head>
<body>
    <canvas id="canvas" tabindex="0"></canvas>
    <div id="info"></div>
    <div id="more-button"><input type="button" value="more"/></div>
    <div id="panels">
        <div id="controls" class="extras">
            <div class="control-row"><span>Columns</span><input type="number" id="column-count" value="15" step="2"></div>

            <div><input type="checkbox" id="full-screen"/><label for="full-screen">Full screen</label></div>
            <div class="control-row"><input id="solve-button" type="button" value="Solve"/></div>
            <div class="control-row"><input id="share-button" type="button" value="Share"/></div>
            <input id="hidden-input"/>

            <div class="control-row"><input id="show-grid" type="checkbox" checked/>
            <label for="show-grid">Show grid</label></div>

            <!-- <input id="show-vertices" type="checkbox" checked/>
            <label for="show-certices">Show vertices</label> -->
        </div>
        <div id="color-scheme" class="extras">
            <div>
                <span>Hat Colors:</span>
                <input type="text" class="color hat" data-coloris value="#6494e433"/>
                <input type="text" class="color hat" data-coloris value="#6494e433"/>
                <input type="text" class="color hat" data-coloris value="#6494e433"/>
                <input type="text" class="color hat" data-coloris value="#6494e433"/>
                <input type="text" class="color hat" data-coloris value="#6494e433"/>
                <input type="text" class="color hat" data-coloris value="#6494e433"/>
            </div><div>
                <span>Anti-Hat Colors:</span>
                <input type="text" class="color cher" data-coloris value="#34343433"/>
                <input type="text" class="color cher" data-coloris value="#34343433"/>
                <input type="text" class="color cher" data-coloris value="#34343433"/>
                <input type="text" class="color cher" data-coloris value="#34343433"/>
                <input type="text" class="color cher" data-coloris value="#34343433"/>
                <input type="text" class="color cher" data-coloris value="#34343433"/>
            </div>
            <div>
                <span>Turtle Colors:</span>
                <input type="text" class="color turtle" data-coloris value="#d4553e33"/>
                <input type="text" class="color turtle" data-coloris value="#d4553e33"/>
                <input type="text" class="color turtle" data-coloris value="#d4553e33"/>
                <input type="text" class="color turtle" data-coloris value="#d4553e33"/>
                <input type="text" class="color turtle" data-coloris value="#d4553e33"/>
                <input type="text" class="color turtle" data-coloris value="#d4553e33"/>
            </div><div>
                <span>Anti-Turtle Colors:</span>
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033"/>
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033"/>
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033"/>
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033"/>
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033"/>
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033"/>
            </div>
        </div>
        <div id="tiles" class="extras">
            <div class="control-row"><input id="tiles-hat" type="checkbox" checked/>
            <label for="tiles-hat">Hat</label></div>
            <div class="control-row"><input id="tiles-anti-hat" type="checkbox" checked/>
            <label for="tiles-anti-hat">Anti Hat</label></div>
            <div class="control-row"><input id="tiles-turtle" type="checkbox"/>
            <label for="tiles-turle">Turtle</label></div>
            <div class="control-row"><input id="tiles-anti-turtle" type="checkbox"/>
            <label for="tiles-anit-turtle">Anti turtle</label></div>
        </div>
        <div id="instructions" class="extras">
            <div>Instructions</div>
            <div>
            <ul>
                <li><span class="key">R</span> to rotate selected tiles (<span class="key">Shift</span>+<span class="key">R</span> to rotate the other way)</li>
                <li><span class="key">A</span> to add a new tile</li>
                <li><span class="key">Space</span> to cycle throw the different tiles</li>
                <li>Arrow keys to navigate the selected tiles around the grid</li>
                <li><span class="key">Delete</span> to delete selected tiles</li>
                <li>Click on a tile to select it (<span class="key">Shift</span>+Click adds to selection)</li>
                <li><span class="key">Ctrl+A</span> to select all tiles</li>
                <li><span class="key">Esc</span> escapes full screen</li>
            </ul>
            <div>Once ready you can click Solve to use a SAT solver. That will find hats that fill the current area. Note that there might be issues at the borders</div>
        </div>
    </div>
</div>
</body>
</html>