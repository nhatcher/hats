<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hats and SAT Solvers</title>
    <link href="style.css?version=0.1.1" rel="stylesheet" >
    <link rel="stylesheet" href="vendor/coloris.min.css">
    <script src="vendor/coloris.min.js"></script>
    <script type="module">
        import createClauses, {fromIndexToTile, addHatsToClauses} from './clauses.js';
        import Grid from './grid.js';

        const offset = 3;

        const myWorker = new Worker("worker.js", {type:'module'});

        myWorker.onmessage = (e) => {
            document.getElementById('solving-dialog').close();
            const {columnCount, rowCount} = grid.getDimensions();
            const ret = e.data;
            if (ret.success) {
                const r = ret.result.filter(i => i > 0);
                const tiles = r.map(h => fromIndexToTile(h)).map( (h) => { return {
                    m:h.m - offset,
                    n:h.n - offset,
                    i: h.i,
                    kind: h.kind,
                    isDragging: false,
                    isSelected: false,
                };}).filter(t => {
                    return t.m > 0 && t.n > 0 && t.m < columnCount && t.n < rowCount;
                });
                grid.setTiles(tiles);
                redrawCanvas();
                infoDetails.innerText = `Success! Solved in ${(ret.time).toFixed(2)} milliseconds. ${tiles.length} tiles and ${ret.clausesCount} clauses`;
            } else {
                infoDetails.innerText = `Failed: ${ret.details}`;
            }
        }

        function updateInfo() {
            const selectedTiles = grid.getSelectedTiles();
            if (selectedTiles.length > 1) {
                infoDetails.innerText = `${selectedTiles.length} selected`
            } else if (selectedTiles.length === 1) {
                const tile = selectedTiles[0];
                const kind = {
                    1: 'Hat',
                    2: 'anti-Hat',
                    3: 'Turtle',
                    4: 'anti-Turtle'
                }[tile.kind];
                infoDetails.innerText = `Selected tile: ${kind} in vertex (${tile.m}, ${tile.n}) and rotation ${tile.i*60} degrees`
            }
        }

        const canvas = document.getElementById('canvas');
        const grid = new Grid(window.innerWidth, window.innerHeight - 60, 15);
        const infoDetails = document.getElementById('info-details');

        canvas.addEventListener('keydown', (event) => {
            grid.onKeydown(event);
            updateInfo();
        });

        const redrawCanvas = (e) => {
            const ratioAEl = document.getElementById('spectre-ratio-a');
            const ratioBEl = document.getElementById('spectre-ratio-b');
            if (!document.getElementById('draw-spectres').checked) {
                ratioAEl.style.display = 'none';
                ratioBEl.style.display = 'none';
                grid.redraw(e);
            } else {
                ratioAEl.style.display = 'block';
                ratioBEl.style.display = 'block';
                grid.drawSpectres(ratioAEl.valueAsNumber, ratioBEl.valueAsNumber);
            }
            updateInfo();
        }


        canvas.addEventListener('mouseup', redrawCanvas);
        canvas.focus();

        document.addEventListener('change', (event) => {
            redrawCanvas();
        })

        document.getElementById("column-count").addEventListener("change", () => {
            const columnCount = document.getElementById("column-count").valueAsNumber;
            grid.setColumnCount(columnCount);
            redrawCanvas();
        });

        function solve() {
            const randomize = document.getElementById("randomize").checked;
            const {columnCount, rowCount} = grid.getDimensions();
            const tileKinds = [];
            if (document.getElementById("tiles-hat").checked) {
                tileKinds.push(1);
            }
            if (document.getElementById("tiles-anti-hat").checked) {
                tileKinds.push(2);
            }
            if (document.getElementById("tiles-turtle").checked) {
                tileKinds.push(3);
            }
            if (document.getElementById("tiles-anti-turtle").checked) {
                tileKinds.push(4);
            }
            infoDetails.innerText = 'Creating clauses';
            const {data, clausesCount} = createClauses(columnCount + offset*2, rowCount + offset*2, tileKinds, randomize);
            addHatsToClauses(grid.tiles.map((h) => {
                return {
                    m: h.m + offset,
                    n: h.n + offset,
                    kind: h.kind,
                    i: h.i,
                }
            }), data);
            infoDetails.innerText = `${clausesCount} clauses created. Solving`;
            document.getElementById('solving-dialog').showModal();
            myWorker.postMessage([data, clausesCount]);
        }
        
        const helpDialog = document.getElementById('help-dialog');
        document.getElementById('close-help-dialog-button').addEventListener('click', () => {
            helpDialog.close();
        });
        document.getElementById('show-help').addEventListener('click', () => {
            helpDialog.showModal();
        });

        const tilesDialog = document.getElementById('tiles-and-colors');
        document.getElementById('close-tiles-and-colors-button').addEventListener('click', () => {
            tilesDialog.close();
        });
        document.getElementById('show-tiles-and-colors').addEventListener('click', () => {
            tilesDialog.show();
        });

        const controlsDialog = document.getElementById('controls');
        document.getElementById('close-controls').addEventListener('click', () => {
            controlsDialog.close();
        });
        document.getElementById('show-controls').addEventListener('click', () => {
            controlsDialog.showModal();
        });

        const gridOptionsDialog = document.getElementById('grid-options');
        document.getElementById('close-grid-options').addEventListener('click', () => {
            gridOptionsDialog.close();
        });
        document.getElementById('show-grid-options').addEventListener('click', () => {
            gridOptionsDialog.showModal();
        });


        const solverDialog = document.getElementById('solver-options-dialog');
        document.getElementById('close-solver-options-dialog').addEventListener('click', () => {
            solverDialog.close();
        });
        document.getElementById('show-solver-options-dialog').addEventListener('click', () => {
            solverDialog.showModal();
        });

        /// On Screen Controls
        document.getElementById('controls-add-tile').addEventListener('click', () => {
            grid.onKeydown({
                code: 'KeyA',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });

        document.getElementById('controls-delete-tiles').addEventListener('click', () => {
            grid.onKeydown({
                code: 'Delete',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });

        document.getElementById('controls-cycle-tiles').addEventListener('click', () => {
            grid.onKeydown({
                code: 'Space',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });

        document.getElementById('controls-move-left').addEventListener('click', () => {
            grid.onKeydown({
                code: 'ArrowLeft',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });

        document.getElementById('controls-move-right').addEventListener('click', () => {
            grid.onKeydown({
                code: 'ArrowRight',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });

        document.getElementById('controls-move-up').addEventListener('click', () => {
            grid.onKeydown({
                code: 'ArrowUp',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });

        document.getElementById('controls-move-down').addEventListener('click', () => {
            grid.onKeydown({
                code: 'ArrowDown',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });

        document.getElementById('controls-rotate-tiles').addEventListener('click', () => {
            grid.onKeydown({
                code: 'KeyR',
                stopPropagation: () => {},
                preventDefault: () => {}
            });
        });


        document.getElementById('solve-button').addEventListener('click', () => {
            solverDialog.close();
            solve();
        });


        window.addEventListener('resize', (event) => {
            grid.setDimensions(window.innerWidth, window.innerHeight - 60);
            updateInfo();
        });

        window.addEventListener('load', redrawCanvas);
    </script>
</head>
<body>
    <div id="toolbar">
        <div class="button" id="show-tiles-and-colors">Tiles</div>
        <div class="button" id="show-grid-options">Grid</div>
        <div class="button" id="show-controls">Controls</div>
        <div class="button" id="show-solver-options-dialog">Solver</div>
        <div class="spacer"></div>
        <div class="button" id="show-help">Help</div>
    </div>
    <canvas id="canvas" tabindex="0"></canvas>
    <div id="info">
        <div id="info-details"></div>
        <a id="github-logo" href="https://github.com/nhatcher/hats">
            <img src="vendor/github-mark.svg">
        </a>
    </div>
    <dialog id="grid-options">
        <div class="control-row"><span>Columns</span><input type="number" id="column-count" value="15" step="2"></div>
        <div class="control-row"><input id="draw-spectres" type="checkbox">
        <label for="draw-spectres">Draw Spectres</label></div>

        <input type="range" value="0.5" min="0" max="2" step="0.01" id="spectre-ratio-a">
        <input type="range" value="0.5" min="0" max="2" step="0.01" id="spectre-ratio-b">

        <div class="control-row"><input id="show-grid" type="checkbox" checked>
        <label for="show-grid">Show grid</label></div>

        <input id="close-grid-options" type="button" value="Close">
    </dialog>
    <dialog id="help-dialog">
        <div>Instructions</div>
        <div>For On Screen Controls (mobile devices) click "Controls" in the toolbar</div>
        <ul>
            <li><span class="key">R</span> to rotate selected tiles (<span class="key">Shift</span>+<span class="key">R</span> to rotate the other way)</li>
            <li><span class="key">A</span> to add a new tile</li>
            <li><span class="key">Space</span> to cycle throw the different tiles</li>
            <li>Arrow keys to navigate the selected tiles around the grid</li>
            <li><span class="key">Delete</span> to delete selected tiles</li>
            <li>Click on a tile to select it (<span class="key">Shift</span>+Click adds to selection)</li>
            <li><span class="key">Ctrl+A</span> to select all tiles</li>
        </ul>
        <div>Once ready you can click Solve to use a SAT solver. That will find hats that fill the current area. Note that there might be issues at the borders</div>
        <input id="close-help-dialog-button" type="button" value="Close">
    </dialog>
    <dialog id="tiles-and-colors">
        <div id="color-scheme" class="extras">
            <div>
                <span>Hat Colors:</span>
                <input type="text" class="color hat" data-coloris value="#6494e433">
                <input type="text" class="color hat" data-coloris value="#6494e433">
                <input type="text" class="color hat" data-coloris value="#6494e433">
                <input type="text" class="color hat" data-coloris value="#6494e433">
                <input type="text" class="color hat" data-coloris value="#6494e433">
                <input type="text" class="color hat" data-coloris value="#6494e433">
            </div><div>
                <span>Anti-Hat Colors:</span>
                <input type="text" class="color cher" data-coloris value="#34343433">
                <input type="text" class="color cher" data-coloris value="#34343433">
                <input type="text" class="color cher" data-coloris value="#34343433">
                <input type="text" class="color cher" data-coloris value="#34343433">
                <input type="text" class="color cher" data-coloris value="#34343433">
                <input type="text" class="color cher" data-coloris value="#34343433">
            </div>
            <div>
                <span>Turtle Colors:</span>
                <input type="text" class="color turtle" data-coloris value="#d4553e33">
                <input type="text" class="color turtle" data-coloris value="#d4553e33">
                <input type="text" class="color turtle" data-coloris value="#d4553e33">
                <input type="text" class="color turtle" data-coloris value="#d4553e33">
                <input type="text" class="color turtle" data-coloris value="#d4553e33">
                <input type="text" class="color turtle" data-coloris value="#d4553e33">
            </div><div>
                <span>Anti-Turtle Colors:</span>
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033">
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033">
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033">
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033">
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033">
                <input type="text" class="color anti-turtle" data-coloris value="#ffe60033">
            </div>
        </div>
        <div id="tiles" class="extras">
            <div class="control-row"><input id="tiles-hat" type="checkbox" checked>
            <label for="tiles-hat">Hat</label></div>
            <div class="control-row"><input id="tiles-anti-hat" type="checkbox" checked>
            <label for="tiles-anti-hat">Anti Hat</label></div>
            <div class="control-row"><input id="tiles-turtle" type="checkbox">
            <label for="tiles-turle">Turtle</label></div>
            <div class="control-row"><input id="tiles-anti-turtle" type="checkbox">
            <label for="tiles-anit-turtle">Anti turtle</label></div>
        </div>
        <input id="close-tiles-and-colors-button" type="button" value="Close ">
    </dialog>
    <dialog id="controls">
        <div class="controls-button" id="controls-add-tile">+</div>
        <div class="controls-button" id="controls-delete-tiles">Del</div>
        <div class="controls-button" id="controls-cycle-tiles">Cycle</div>
        <div class="controls-button" id="controls-rotate-tiles">Rotate</div>

        <div class="controls-button" id="controls-move-left">Left</div>
        <div class="controls-button" id="controls-move-right">Right</div>


        <div class="controls-button" id="controls-move-up">Up</div>
        <div class="controls-button" id="controls-move-down">Down</div>
        
        <input type="button" id="close-controls" value="Close">
    </dialog>
    <dialog id="solver-options-dialog">
        <div class="control-row">
            <input id="randomize" type="checkbox">
            <label for="randomize">Randomize</label>
        </div>
        <input type="button" id="solve-button" value="Solve">
        <input type="button" id="close-solver-options-dialog" value="Close">
    </dialog>
    <dialog id="solving-dialog"><div>Please wait</div></dialog>
</div>
</body>
</html>